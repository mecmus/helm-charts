# Exemple de configuration pour Microsoft Entra ID (Azure AD)
# Ce fichier montre comment configurer FileSender avec Entra ID comme fournisseur d'identité
# et envoyer les emails via Microsoft Graph API (shared mailbox, pas de licence requise)

filesender:
  siteUrl: "https://filesender.example.com"
  siteName: "FileSender"
  admin: "admin@example.com"
  adminEmail: "admin@example.com"
  emailReplyTo: "noreply@example.com"
  
  # Email via Microsoft Graph API
  # Réutilise la même application Entra ID que le SAML SSO
  # Le tenantId et applicationId sont pris depuis simplesamlphp.saml.entra.*
  mail:
    enabled: true
    fromAddress: "noreply-filesender@example.com"  # Shared mailbox (gratuite, pas de licence)
    clientSecret: "votre-client-secret"  # Créé dans Entra ID > App > Certificates & secrets

simplesamlphp:
  # IMPORTANT: Désactiver les utilisateurs locaux pour utiliser Entra ID
  localUsers:
    enabled: false
  
  saml:
    provider: "entra"
    entra:
      tenantId: "YOUR-TENANT-ID"
      applicationId: "YOUR-APP-ID"
      # metadataUrl est auto-construit à partir de tenantId et applicationId
      # Override optionnel : metadataUrl: "https://login.microsoftonline.com/YOUR-TENANT-ID/federationmetadata/2007-06/federationmetadata.xml?appid=YOUR-APP-ID"

# Configuration PostgreSQL (recommandé pour les sessions)
postgresql:
  internal:
    enabled: true
    database: "filesender"
    username: "filesender"
    password: ""  # Généré automatiquement

# Configuration Ingress (HTTPS obligatoire pour SAML)
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  hosts:
    - host: filesender.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: filesender-tls
      hosts:
        - filesender.example.com

# ===============================================================================
# PROCÉDURE DE CONFIGURATION DANS MICROSOFT ENTRA ID
# ===============================================================================
#
# Une seule application Entra ID est utilisée à la fois pour le SAML SSO et
# l'envoi d'emails via Graph API. Pas besoin d'en créer une seconde.
#
# 1. Créer l'application dans Entra ID:
#    - Aller dans Azure Portal > Entra ID > Applications d'entreprise
#    - Cliquer sur "Nouvelle application" > "Créez votre propre application"
#    - Nom: "FileSender"
#    - Sélectionner "Intégrer n'importe quelle autre application... (Non-galerie)"
#
# 2. Configurer le Single Sign-On (SAML):
#    - Ouvrir l'application FileSender > Single sign-on > SAML
#    - Configuration SAML de base:
#      * Identificateur (ID d'entité): https://filesender.example.com
#      * URL de réponse (ACS): https://filesender.example.com/simplesaml/module.php/saml/sp/saml2-acs.php/default-sp
#
# 3. Configurer les attributs et revendications:
#    - S'assurer que l'attribut emailaddress pointe vers user.mail
#
# 4. Récupérer les informations:
#    - Tenant ID: Vue d'ensemble de l'application
#    - Application (Client) ID: Vue d'ensemble de l'application
#
# 5. Assigner des utilisateurs/groupes:
#    - Aller dans Utilisateurs et groupes
#    - Ajouter les utilisateurs ou groupes qui peuvent accéder à FileSender
#
# 6. Configurer l'envoi d'emails via Graph API:
#
#    a) Créer un client secret:
#       - Aller dans l'App registration (pas l'Enterprise Application)
#         Azure Portal > Entra ID > App registrations > FileSender
#       - Certificates & secrets > New client secret
#       - Copier la valeur du secret (visible une seule fois !)
#       - Mettre cette valeur dans filesender.mail.clientSecret
#
#    b) Ajouter la permission API Mail.Send:
#       - App registrations > FileSender > API permissions > Add a permission
#       - Microsoft Graph > Application permissions > Mail > Mail.Send
#       - Cliquer sur "Grant admin consent" (consentement administrateur requis)
#
#    c) Créer une shared mailbox Exchange Online (gratuite, pas de licence requise):
#       PowerShell:
#         New-Mailbox -Shared -Name "FileSender" -PrimarySmtpAddress "noreply-filesender@contoso.com"
#
#    d) (Recommandé) Restreindre l'application à la seule shared mailbox:
#       PowerShell:
#         New-ApplicationAccessPolicy \
#           -AppId "YOUR-APP-ID" \
#           -PolicyScopeGroupId "noreply-filesender@contoso.com" \
#           -AccessRight RestrictAccess \
#           -Description "Restrict FileSender to its shared mailbox"
#
# ===============================================================================
