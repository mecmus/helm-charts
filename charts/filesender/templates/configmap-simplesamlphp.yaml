apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "filesender.fullname" . }}-simplesamlphp
  labels:
    {{- include "filesender.labels" . | nindent 4 }}
data:
  config.php: |
    <?php
    // SimpleSAMLphp configuration
    
    $config = [
        'baseurlpath' => '{{ .Values.filesender.siteUrl }}/simplesaml/',
        'certdir' => 'cert/',
        'loggingdir' => 'log/',
        'datadir' => 'data/',
        'tempdir' => '/tmp/simplesaml',
        
        'technicalcontact_name' => 'Administrator',
        'technicalcontact_email' => '{{ .Values.filesender.adminEmail }}',
        
        'secretsalt' => getenv('SIMPLESAMLPHP_SECRET_SALT'),
        'auth.adminpassword' => getenv('SIMPLESAMLPHP_ADMIN_PASSWORD'),
        
        'admin.protectindexpage' => true,
        'admin.protectmetadata' => true,
        
        'logging.level' => SimpleSAML\Logger::NOTICE,
        'logging.handler' => 'syslog',
        
        {{- if .Values.simplesamlphp.localUsers.enabled }}
        // Enable modules for fake/local users mode
        'module.enable' => [
            'exampleauth' => true,
            'core' => true,
            'admin' => true,
            'saml' => true,
        ],
        'enable.saml20-idp' => true,
        {{- else }}
        'module.enable' => [
            'core' => true,
            'admin' => true,
            'saml' => true,
        ],
        'enable.saml20-idp' => false,
        {{- end }}
        'enable.shib13-idp' => false,
        'enable.adfs-idp' => false,
        'enable.wsfed-sp' => false,
        'enable.authmemcookie' => false,
    ];
  
  authsources.php: |
    <?php
    $config = [
        'admin' => [
            'core:AdminPassword',
        ],
        
        {{- if .Values.simplesamlphp.localUsers.enabled }}
        // SP configuration for local users mode
        '{{ .Values.simplesamlphp.authenticationSource }}' => [
            'saml:SP',
            'entityID' => '{{ .Values.filesender.siteUrl }}/simplesaml/module.php/saml/sp/metadata.php/{{ .Values.simplesamlphp.authenticationSource }}',
            'idp' => 'urn:x-simplesamlphp:example-idp',
            'discoURL' => null,
        ],
        
        // Local users for testing
        'example-userpass' => [
            'exampleauth:UserPass',
            {{- range .Values.simplesamlphp.localUsers.users }}
            ('{{ .username }}:' . getenv('LOCAL_USER_{{ .username | upper }}_PASSWORD')) => [
                'uid' => ['{{ .uid }}'],
                'email' => ['{{ .email }}'],
                'cn' => ['{{ .username }}'],
                'eduPersonPrincipalName' => ['{{ .uid }}@example.com'],
            ],
            {{- end }}
        ],
        {{- else }}
        // SP configuration for external IdP
        '{{ .Values.simplesamlphp.authenticationSource }}' => [
            'saml:SP',
            'entityID' => '{{ .Values.filesender.siteUrl }}/simplesaml/module.php/saml/sp/metadata.php/{{ .Values.simplesamlphp.authenticationSource }}',
            'idp' => '{{ .Values.simplesamlphp.idp.entityId }}',
        ],
        {{- end }}
    ];
  
  {{- if .Values.simplesamlphp.localUsers.enabled }}
  saml20-idp-hosted.php: |
    <?php
    // Hosted IdP metadata for local users mode
    $metadata['urn:x-simplesamlphp:example-idp'] = [
        'host' => '__DEFAULT__',
        'privatekey' => 'server.pem',
        'certificate' => 'server.crt',
        'auth' => 'example-userpass',
    ];
  {{- end }}
  
  {{- if and (not .Values.simplesamlphp.localUsers.enabled) .Values.simplesamlphp.idp.entityId }}
  saml20-idp-remote.php: |
    <?php
    $metadata['{{ .Values.simplesamlphp.idp.entityId }}'] = [
        'SingleSignOnService' => '{{ .Values.simplesamlphp.idp.ssoUrl }}',
        'SingleLogoutService' => '',
        'certificate' => '{{ .Values.simplesamlphp.idp.certificate }}',
    ];
  {{- end }}
