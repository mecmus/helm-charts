apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "filesender.fullname" . }}-simplesamlphp
  labels:
    {{- include "filesender.labels" . | nindent 4 }}
data:
  config.php: |
    <?php
    $config = [
        'baseurlpath' => '{{ .Values.filesender.siteUrl }}/simplesaml/',
        'certdir' => 'cert/',
        'loggingdir' => 'log/',
        'datadir' => 'data/',
        'tempdir' => '/tmp/simplesaml',
        'technicalcontact_name' => 'Administrator',
        'technicalcontact_email' => '{{ .Values.filesender.adminEmail }}',
        'secretsalt' => getenv('SIMPLESAMLPHP_SECRET_SALT'),
        'auth.adminpassword' => getenv('SIMPLESAMLPHP_ADMIN_PASSWORD'),
        'admin.protectindexpage' => true,
        'admin.protectmetadata' => true,
        'logging.level' => SimpleSAML\Logger::NOTICE,
        'logging.handler' => 'syslog',
        
        // Session storage in PostgreSQL
        'store.type' => '{{ .Values.simplesamlphp.session.storeType | default "sql" }}',
        'store.sql.dsn' => 'pgsql:host={{ if .Values.postgresql.external.enabled }}{{ .Values.postgresql.external.host }}{{ else }}{{ include "filesender.fullname" . }}-postgresql{{ end }};port={{ if .Values.postgresql.external.enabled }}{{ .Values.postgresql.external.port }}{{ else }}5432{{ end }};dbname={{ if .Values.postgresql.external.enabled }}{{ .Values.postgresql.external.database }}{{ else }}{{ .Values.postgresql.internal.database }}{{ end }}',
        'store.sql.username' => '{{ if .Values.postgresql.external.enabled }}{{ .Values.postgresql.external.username }}{{ else }}{{ .Values.postgresql.internal.username }}{{ end }}',
        'store.sql.password' => getenv('POSTGRES_PASSWORD'),
        'store.sql.prefix' => '{{ .Values.simplesamlphp.session.tablePrefix | default "simplesaml_" }}',
        
        // Session cookie configuration
        'session.cookie.path' => '{{ .Values.simplesamlphp.session.cookiePath | default "/" }}',
        'session.phpsession.cookiename' => '{{ .Values.simplesamlphp.session.cookieName | default "SimpleSAMLSessionID" }}',
        'session.cookie.secure' => true,
        'session.cookie.samesite' => 'None',
        
        'module.enable' => [
            'core' => true,
            'admin' => true,
            'saml' => true,
            'exampleauth' => true, // Toujours requis pour le backend de l'IdP local
        ],
        
        // IMPORTANT : On réactive l'IdP car on va s'auto-héberger
        'enable.saml20-idp' => {{ .Values.simplesamlphp.localUsers.enabled }},
    ];
  
  authsources.php: |
    <?php
    $config = [
        'admin' => ['core:AdminPassword'],
        
        {{- if or .Values.simplesamlphp.localUsers.enabled (not .Values.simplesamlphp.entraId.enabled) }}
        {{- if .Values.simplesamlphp.localUsers.enabled }}
        // Mode local pour tests - La source "Visible" par Filesender (Type SAML)
        '{{ .Values.simplesamlphp.authenticationSource }}' => [
            'saml:SP',
            'entityID' => '{{ .Values.filesender.siteUrl }}/simplesaml/module.php/saml/sp/metadata.php/{{ .Values.simplesamlphp.authenticationSource }}',
            'idp' => 'urn:x-simplesamlphp:local-idp', // Doit correspondre à l'IdP défini plus bas
            'discoURL' => null,
        ],
        
        // 2. La source "Interne" (Base de données utilisateurs)
        'example-userpass' => [
            'exampleauth:UserPass',
            {{- range .Values.simplesamlphp.localUsers.users }}
            ('{{ .username }}:' . getenv('LOCAL_USER_{{ .username | upper }}_PASSWORD')) => [
                'uid' => ['{{ .uid }}'],
                'mail' => ['{{ .email }}'],
                'email' => ['{{ .email }}'],
                'cn' => ['{{ .username }}'],
                'eduPersonTargetedID' => ['{{ .uid }}'],
                'eduPersonPrincipalName' => ['{{ .uid }}@example.com'],
            ],
            {{- end }}
        ],
        {{- else }}
        // Mode PROD - IdP externe standard
        '{{ .Values.simplesamlphp.authenticationSource }}' => [
            'saml:SP',
            'entityID' => '{{ .Values.filesender.siteUrl }}/simplesaml/module.php/saml/sp/metadata.php/{{ .Values.simplesamlphp.authenticationSource }}',
            'idp' => '{{ .Values.simplesamlphp.idp.entityId }}',
            'discoURL' => null,
        ],
        {{- end }}
        {{- else }}
        // Mode Microsoft Entra ID (Azure AD)
        '{{ .Values.simplesamlphp.authenticationSource }}' => [
            'saml:SP',
            'entityID' => '{{ .Values.filesender.siteUrl }}',
            'idp' => 'https://sts.windows.net/{{ .Values.simplesamlphp.entraId.tenantId }}/',
            'discoURL' => null,
            {{- if .Values.simplesamlphp.entraId.attributes }}
            // Mapping des attributs Entra ID vers attributs FileSender
            'authproc' => [
                // Convertit les claims Entra ID en attributs SAML standard
                [
                    'class' => 'core:AttributeMap',
                    'oid2name',
                ],
            ],
            {{- end }}
        ],
        {{- end }}
    ];

  # Définition de l'IdP Local (C'est ce fichier qui manquait dans votre erreur Metadata initiale)
  saml20-idp-hosted.php: |
    <?php
    $metadata['urn:x-simplesamlphp:local-idp'] = [
        'host' => '__DEFAULT__',
        'privatekey' => 'server.pem',
        'certificate' => 'server.crt',
        'auth' => 'example-userpass', // Utilise la liste d'utilisateurs définie dans authsources
    ];

  # Définition pour que le SP trouve l'IdP (Même si c'est local)
  saml20-idp-remote.php: |
    <?php
    {{- if .Values.simplesamlphp.localUsers.enabled }}
    // Configuration IdP local pour tests
    $metadata['urn:x-simplesamlphp:local-idp'] = [
        'name' => ['en' => 'Local Test IdP'],
        'description' => 'Local IdP for testing',
        'SingleSignOnService'  => '{{ .Values.filesender.siteUrl }}/simplesaml/saml2/idp/SSOService.php',
        'SingleLogoutService'  => '{{ .Values.filesender.siteUrl }}/simplesaml/saml2/idp/SingleLogoutService.php',
        'certificate' => 'server.crt',
    ];
    {{- else if .Values.simplesamlphp.entraId.enabled }}
    // Configuration Microsoft Entra ID (Azure AD)
    $metadata['https://sts.windows.net/{{ .Values.simplesamlphp.entraId.tenantId }}/'] = [
        'name' => ['en' => 'Microsoft Entra ID', 'fr' => 'Microsoft Entra ID'],
        'description' => 'Microsoft Entra ID SAML Identity Provider',
        'SingleSignOnService' => 'https://login.microsoftonline.com/{{ .Values.simplesamlphp.entraId.tenantId }}/saml2',
        'SingleLogoutService' => 'https://login.microsoftonline.com/{{ .Values.simplesamlphp.entraId.tenantId }}/saml2',
        {{- if .Values.simplesamlphp.idp.certificate }}
        'certificate' => '{{ .Values.simplesamlphp.idp.certificate }}',
        {{- end }}
        {{- if .Values.simplesamlphp.idp.metadataUrl }}
        // Alternative: utiliser l'URL de métadonnées
        // 'metadata-set' => 'saml20-idp-remote',
        {{- end }}
    ];
    {{- else if .Values.simplesamlphp.idp.entityId }}
    // Configuration IdP externe générique
    $metadata['{{ .Values.simplesamlphp.idp.entityId }}'] = [
        'SingleSignOnService' => '{{ .Values.simplesamlphp.idp.ssoUrl }}',
        'SingleLogoutService' => '',
        {{- if .Values.simplesamlphp.idp.certificate }}
        'certificate' => '{{ .Values.simplesamlphp.idp.certificate }}',
        {{- end }}
    ];
    {{- end }}
  saml20-sp-remote.php: |
    <?php
    {{- if .Values.simplesamlphp.localUsers.enabled }}
    // L'IdP local doit connaitre le SP local
    $metadata['{{ .Values.filesender.siteUrl }}/simplesaml/module.php/saml/sp/metadata.php/{{ .Values.simplesamlphp.authenticationSource }}'] = [
        'AssertionConsumerService' => '{{ .Values.filesender.siteUrl }}/simplesaml/module.php/saml/sp/saml2-acs.php/{{ .Values.simplesamlphp.authenticationSource }}',
        'SingleLogoutService' => '{{ .Values.filesender.siteUrl }}/simplesaml/module.php/saml/sp/saml2-logout.php/{{ .Values.simplesamlphp.authenticationSource }}',
    ];
    {{- end }}