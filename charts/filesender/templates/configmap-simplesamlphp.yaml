apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "filesender.fullname" . }}-simplesamlphp
  labels:
    {{- include "filesender.labels" . | nindent 4 }}
data:
  config.php: |
    <?php
    // SimpleSAMLphp configuration
    
    $config = [
        'baseurlpath' => '{{ .Values.filesender.siteUrl }}/simplesaml/',
        'certdir' => 'cert/',
        'loggingdir' => 'log/',
        'datadir' => 'data/',
        'tempdir' => '/tmp/simplesaml',
        
        'technicalcontact_name' => 'Administrator',
        'technicalcontact_email' => '{{ .Values.filesender.adminEmail }}',
        
        'secretsalt' => getenv('SIMPLESAMLPHP_SECRET_SALT'),
        'auth.adminpassword' => getenv('SIMPLESAMLPHP_ADMIN_PASSWORD'),
        
        'admin.protectindexpage' => true,
        'admin.protectmetadata' => true,
        
        'logging.level' => SimpleSAML\Logger::NOTICE,
        'logging.handler' => 'syslog',
        
        // Configuration des modules
        'module.enable' => [
            'core' => true,
            'admin' => true,
            'saml' => true,
            // Active exampleauth uniquement si on est en mode test local
            'exampleauth' => {{ .Values.simplesamlphp.localUsers.enabled }},
        ],
        
        // On n'a pas besoin d'être un IdP pour Filesender (on est un SP)
        'enable.saml20-idp' => false,
        'enable.shib13-idp' => false,
        'enable.adfs-idp' => false,
        'enable.wsfed-sp' => false,
        'enable.authmemcookie' => false,
    ];
  
  authsources.php: |
    <?php
    $config = [
        // Mot de passe admin de l'interface SimpleSAMLphp
        'admin' => [
            'core:AdminPassword',
        ],
        
        {{- if .Values.simplesamlphp.localUsers.enabled }}
        /**
         * MODE TEST / LOCAL
         * Authentification directe sans passer par SAML
         * Cela évite les erreurs de métadonnées et de certificats
         */
        '{{ .Values.simplesamlphp.authenticationSource }}' => [
            'exampleauth:UserPass',
            {{- range .Values.simplesamlphp.localUsers.users }}
            ('{{ .username }}:' . getenv('LOCAL_USER_{{ .username | upper }}_PASSWORD')) => [
                'uid' => ['{{ .uid }}'],
                'email' => ['{{ .email }}'],
                'cn' => ['{{ .username }}'],
                'eduPersonPrincipalName' => ['{{ .uid }}@example.com'],
                // Ajout d'attributs souvent requis par Filesender
                'displayName' => ['{{ .username }}'],
            ],
            {{- end }}
        ],
        {{- else }}
        /**
         * MODE PRODUCTION (SAML)
         * Authentification via un IdP externe (Shibboleth, ADFS, etc.)
         */
        '{{ .Values.simplesamlphp.authenticationSource }}' => [
            'saml:SP',
            // L'URL de métadonnées de NOTRE service (Filesender)
            'entityID' => '{{ .Values.filesender.siteUrl }}/simplesaml/module.php/saml/sp/metadata.php/{{ .Values.simplesamlphp.authenticationSource }}',
            // L'identifiant du fournisseur d'identité distant
            'idp' => '{{ .Values.simplesamlphp.idp.entityId }}',
            'discoURL' => null,
        ],
        {{- end }}
    ];
  
  # Ce fichier n'est généré que si on est en PROD (users locaux désactivés)
  # car en mode test (exampleauth), on n'a pas besoin de métadonnées distantes.
  {{- if and (not .Values.simplesamlphp.localUsers.enabled) .Values.simplesamlphp.idp.entityId }}
  saml20-idp-remote.php: |
    <?php
    /**
     * Métadonnées du fournisseur d'identité (IdP) distant
     * Utilisé uniquement pour la vraie connexion SAML
     */
    $metadata['{{ .Values.simplesamlphp.idp.entityId }}'] = [
        'SingleSignOnService' => '{{ .Values.simplesamlphp.idp.ssoUrl }}',
        'SingleLogoutService' => '',
        'certificate' => '{{ .Values.simplesamlphp.idp.certificate }}',
    ];
  {{- end }}