apiVersion: v1
kind: Secret
metadata:
  name: {{ include "filesender.fullname" . }}
  labels:
    {{- include "filesender.labels" . | nindent 4 }}
type: Opaque
stringData:
  # SimpleSAMLphp secrets
  {{- $secretObj := (lookup "v1" "Secret" .Release.Namespace (include "filesender.fullname" .)) | default dict }}
  {{- $secretData := (get $secretObj "data") | default dict }}
  simplesamlphp-admin-password: {{ .Values.simplesamlphp.adminPassword | default (get $secretData "simplesamlphp-admin-password" | b64dec) | default (randAlphaNum 32) | quote }}
  simplesamlphp-secret-salt: {{ .Values.simplesamlphp.secretSalt | default (get $secretData "simplesamlphp-secret-salt" | b64dec) | default (randAlphaNum 64) | quote }}
  
  {{- if .Values.simplesamlphp.localUsers.enabled }}
  # Local user passwords
  {{- range .Values.simplesamlphp.localUsers.users }}
  local-user-{{ .username }}-password: {{ .password | default (get $secretData (printf "local-user-%s-password" .username) | b64dec) | default (randAlphaNum 16) | quote }}
  {{- end }}
  {{- end }}
  
  # PostgreSQL password (for internal database)
  {{- if .Values.postgresql.internal.enabled }}
  postgres-password: {{ .Values.postgresql.internal.password | default (get $secretData "postgres-password" | b64dec) | default (randAlphaNum 32) | quote }}
  {{- end }}
  
  # PostgreSQL password (for external database)
  {{- if and .Values.postgresql.external.enabled (not .Values.postgresql.external.existingSecret) }}
  postgres-external-password: {{ .Values.postgresql.external.password | quote }}
  {{- end }}
  
  # Microsoft Graph API client secret (for email sending)
  {{- if and .Values.filesender.mail.enabled (not .Values.filesender.mail.existingSecret) }}
  graph-client-secret: {{ .Values.filesender.mail.clientSecret | quote }}
  {{- end }}
  
  # S3 credentials
  {{- if and (eq .Values.filesender.storage.type "CloudS3") (not .Values.filesender.storage.s3.existingSecret) }}
  s3-access-key: {{ .Values.filesender.storage.s3.key | quote }}
  s3-secret-key: {{ .Values.filesender.storage.s3.secret | quote }}
  {{- end }}
