apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "filesender.fullname" . }}-filesender
  labels:
    {{- include "filesender.labels" . | nindent 4 }}
data:
  config.php: |
    <?php
    // FileSender configuration file
    
    // Site configuration
    $config['site_url'] = '{{ .Values.filesender.siteUrl }}';
    $config['site_name'] = '{{ .Values.filesender.siteName }}';
    $config['admin'] = '{{ .Values.filesender.admin }}';
    $config['admin_email'] = '{{ .Values.filesender.adminEmail }}';
    $config['email_reply_to'] = '{{ .Values.filesender.emailReplyTo }}';
    $config['default_timezone'] = '{{ .Values.filesender.defaultTimezone }}';
    
    // Database configuration
    {{- if .Values.postgresql.external.enabled }}
    $config['db_type'] = 'pgsql';
    $config['db_host'] = '{{ .Values.postgresql.external.host }}';
    $config['db_port'] = {{ .Values.postgresql.external.port }};
    $config['db_database'] = '{{ .Values.postgresql.external.database }}';
    $config['db_username'] = '{{ .Values.postgresql.external.username }}';
    $config['db_password'] = getenv('POSTGRES_PASSWORD');
    {{- else if .Values.postgresql.internal.enabled }}
    $config['db_type'] = 'pgsql';
    $config['db_host'] = '{{ include "filesender.fullname" . }}-postgresql';
    $config['db_port'] = 5432;
    $config['db_database'] = '{{ .Values.postgresql.internal.database }}';
    $config['db_username'] = '{{ .Values.postgresql.internal.username }}';
    $config['db_password'] = getenv('POSTGRES_PASSWORD');
    {{- end }}
    
    // Storage configuration
    $config['storage_type'] = '{{ .Values.filesender.storage.type }}';
    $config['storage_filesystem_path'] = '{{ .Values.filesender.storage.path }}';
    $config['storage_filesystem_shred_path'] = '{{ .Values.filesender.storage.shredPath | default "/opt/filesender/filesender/shredfiles" }}';
    $config['storage_usage_warning'] = {{ .Values.filesender.storage.usageWarning | default 20 }};
    
    // Paths configuration
    $config['tmp_path'] = '{{ .Values.filesender.paths.tmp | default "/opt/filesender/filesender/tmp/" }}';
    $config['log_facilities'] = [
        'path' => '{{ .Values.filesender.paths.log | default "/opt/filesender/filesender/log/" }}',
    ];
    
    // Session configuration
    $config['session_cookie_path'] = '{{ .Values.filesender.sessionCookiePath | default "/" }}';
    $config['auth_sp_force_session_start_first'] = {{ .Values.filesender.auth.forceSessionStartFirst | default true }};
    
    // Transfer limits
    $config['max_transfer_size'] = {{ .Values.filesender.maxTransferSize }};
    $config['max_transfer_files'] = {{ .Values.filesender.maxTransferFiles }};
    $config['default_transfer_days_valid'] = {{ .Values.filesender.defaultTransferDaysValid }};
    $config['max_transfer_days_valid'] = {{ .Values.filesender.maxTransferDaysValid }};
    
    // TeraSender configuration
    $config['terasender_enabled'] = {{ .Values.filesender.terasender.enabled | default true }};
    $config['terasender_advanced'] = {{ .Values.filesender.terasender.advanced | default false }};
    $config['terasender_worker_count'] = {{ .Values.filesender.terasender.workerCount | default 6 }};
    $config['terasender_start_mode'] = '{{ .Values.filesender.terasender.startMode | default "multiple" }}';
    
    // Encryption configuration
    $config['encryption_enabled'] = {{ .Values.filesender.encryption.enabled | default true }};
    $config['encryption_mandatory'] = {{ .Values.filesender.encryption.mandatory | default false }};
    $config['encryption_min_password_length'] = {{ .Values.filesender.encryption.minPasswordLength | default 12 }};
    $config['encryption_password_must_have_upper_and_lower_case'] = {{ .Values.filesender.encryption.mustHaveUpperAndLowerCase | default true }};
    $config['encryption_password_must_have_numbers'] = {{ .Values.filesender.encryption.mustHaveNumbers | default true }};
    $config['encryption_password_must_have_special_characters'] = {{ .Values.filesender.encryption.mustHaveSpecialCharacters | default true }};
    
    // Guest configuration
    $config['guest_enabled'] = {{ .Values.filesender.guest.enabled | default true }};
    $config['guest_default_days_valid'] = {{ .Values.filesender.guest.defaultDaysValid | default 20 }};
    $config['guest_max_days_valid'] = {{ .Values.filesender.guest.maxDaysValid | default 20 }};
    $config['guest_min_days_valid'] = {{ .Values.filesender.guest.minDaysValid | default 1 }};
    $config['guest_max_recipients'] = {{ .Values.filesender.guest.maxRecipients | default 50 }};
    $config['guest_limit_per_user'] = {{ .Values.filesender.guest.limitPerUser | default 50 }};
    
    // Security configuration
    $config['force_ssl'] = {{ .Values.filesender.security.forceSSL | default true }};
    $config['use_strict_csp'] = {{ .Values.filesender.security.useStrictCSP | default true }};
    $config['ban_extension'] = '{{ .Values.filesender.security.banExtension | default "exe,bat" }}';
    
    // Authentication - SAML configuration is required even for fake mode
    $config['auth_sp_type'] = 'saml';
    $config['auth_sp_saml_simplesamlphp_url'] = '{{ .Values.filesender.siteUrl }}/simplesaml';
    $config['auth_sp_saml_simplesamlphp_location'] = '/opt/filesender/simplesaml/';
    $config['auth_sp_saml_authentication_source'] = '{{ .Values.simplesamlphp.authenticationSource }}';
    $config['auth_sp_saml_uid_attribute'] = '{{ .Values.simplesamlphp.uidAttribute }}';
    $config['auth_sp_saml_email_attribute'] = '{{ .Values.simplesamlphp.emailAttribute }}';
    $config['auth_sp_saml_name_attribute'] = '{{ .Values.simplesamlphp.nameAttribute }}';
