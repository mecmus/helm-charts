name: Release Charts

on:
  push:
    branches:
      - main

jobs:
  release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.7.0
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Update README chart table
        run: |
          # Build the new table from Chart.yaml files
          table="| Chart | Version | Description |\n|-------|---------|-------------|"
          for chart_dir in $(ls -d charts/*/); do
            chart_yaml="${chart_dir}Chart.yaml"
            if [ -f "$chart_yaml" ]; then
              name=$(grep '^name:' "$chart_yaml" | head -1 | sed 's/^name: *//')
              version=$(grep '^version:' "$chart_yaml" | head -1 | sed 's/^version: *//')
              description=$(grep '^description:' "$chart_yaml" | head -1 | sed 's/^description: *//')
              table="${table}\n| [${name}](${chart_dir}) | ${version} | ${description} |"
            fi
          done

          # Replace table between markers in README.md
          awk -v table="$table" '
            /<!-- CHART-TABLE-START -->/ { print; printf "%s\n", table; skip=1; next }
            /<!-- CHART-TABLE-END -->/ { skip=0 }
            !skip { print }
          ' README.md > README.tmp && mv README.tmp README.md

          # Commit only if there are changes
          if ! git diff --quiet README.md; then
            git add README.md
            git commit -m "docs: mise Ã  jour automatique du tableau de charts dans le README"
            git push
          fi

      - name: Update release changelogs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          now=$(date +%s)
          cutoff=$((now - 600))

          while read -r tag tag_date; do
            if [ "$tag_date" -lt "$cutoff" ]; then
              break
            fi

            # Extract chart name (strip trailing version like -3.5.1)
            chart_name=$(echo "$tag" | sed 's/-[0-9][0-9.]*$//')

            if [ "$chart_name" = "$tag" ]; then
              echo "Could not determine chart name from tag $tag, skipping"
              continue
            fi

            # Find the most recent previous tag for the same chart
            prev_tag=$(git for-each-ref --sort=creatordate --format='%(refname:short)' refs/tags \
              | grep "^${chart_name}-[0-9]" | grep -v "^${tag}$" | tail -1)

            if [ -z "$prev_tag" ]; then
              echo "No previous tag found for $tag (first release), skipping changelog"
              continue
            fi

            # Generate changelog filtered to the chart directory
            changelog=$(git log --pretty=format:"- %s (%h)" "${prev_tag}..${tag}" -- "charts/${chart_name}/")

            if [ -z "$changelog" ]; then
              echo "No changes found between $prev_tag and $tag, skipping"
              continue
            fi

            # Get existing release description
            existing_body=$(gh release view "$tag" --json body -q '.body' 2>/dev/null || echo "")

            # Write the new body to a temp file to safely handle special characters
            tmpfile=$(mktemp)
            if [ -n "$existing_body" ]; then
              printf '%s\n\n' "$existing_body" >> "$tmpfile"
            fi
            printf '## Changements depuis %s\n\n%s\n' "$prev_tag" "$changelog" >> "$tmpfile"

            gh release edit "$tag" --notes-file "$tmpfile"
            rm -f "$tmpfile"
            echo "Updated changelog for $tag (since $prev_tag)"
          done < <(git for-each-ref --sort=-creatordate --format='%(refname:short) %(creatordate:unix)' refs/tags)
